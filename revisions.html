<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©visions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/revisions.css">
</head>
<body>
    <div id="custom-alert-container" class="custom-alert-container"></div>
    <div id="notification-popup" class="notification-popup"></div>
    <div class="content-wrapper">
        <!-- Statistiques -->
        <div class="stats-container">
            <div class="stats-card">
                <div class="stats-icon blue">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="total-chapters">0</div>
                    <div class="stats-label">Chapitres au total</div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="completed-chapters">0</div>
                    <div class="stats-label">Chapitres compl√©t√©s</div>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-icon orange">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="remaining-chapters">0</div>
                    <div class="stats-label">Chapitres restants</div>
                </div>
            </div>
        </div>

        <!-- Barre de progression -->
        <div class="progress-container">
            <div class="progress-header">
                <div class="progress-title">
                    <i class="fas fa-chart-line"></i>
                    Progression globale
                </div>
                <div class="progress-value" id="progress-percentage">0%</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Boutons principaux -->
        <div class="main-actions">
            <button class="btn btn-primary" id="show-notes-btn">
                <i class="fas fa-star"></i>
                Notes et Moyennes
            </button>
            <button class="btn btn-secondary" id="show-revisions-btn">
                <i class="fas fa-book"></i>
                R√©visions
            </button>
            <button class="btn btn-success" id="add-chapter-btn">
                <i class="fas fa-plus"></i>
                Ajouter un chapitre
            </button>
        </div>

        <div class="revisions-section" style="display: none;">
            <div class="subjects-container">
                <!-- Les cartes de mati√®res seront g√©n√©r√©es dynamiquement ici -->
            </div>
        </div>

        <!-- Nouvelle section pour les notes -->
        <div class="notes-section" style="display: none;">
            <div class="subjects-container-notes">
                <!-- Les cartes de mati√®res seront g√©n√©r√©es ici pour les notes -->
            </div>
        </div>
    </div>

    <!-- Popup de saisie de note -->
    <div class="note-popup" id="notePopup">
        <div class="note-popup-content">
            <div class="note-popup-header">
                <div class="note-popup-title">Saisir la note du quiz</div>
                <button class="note-popup-close" onclick="closeNotePopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="note-input-container">
                <div class="note-input-group">
                    <div class="note-input-wrapper">
                        <label class="note-input-label">Note</label>
                        <input type="number" class="note-input" id="noteInput" min="0" step="0.5" placeholder="Votre note">
                    </div>
                    <div class="note-scale-wrapper">
                        <label class="note-input-label">Sur</label>
                        <select id="noteScale" class="note-scale">
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20" selected>20</option>
                        </select>
                    </div>
                </div>
                <button class="note-submit" onclick="submitNote()">Enregistrer la note</button>
            </div>
        </div>
    </div>

    <!-- Popup d'ajout de chapitre -->
    <div class="note-popup" id="addChapterPopup" style="display: none;">
        <div class="note-popup-content">
            <div class="note-popup-header">
                <div class="note-popup-title">Ajouter un nouveau chapitre</div>
                <button class="note-popup-close" onclick="closeAddChapterPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chapter-form">
                <div class="form-group">
                    <label>Mati√®re</label>
                    <select id="subjectSelect" required>
                        <option value="">S√©lectionner une mati√®re</option>
                        <option value="Histoire">Histoire</option>
                        <option value="G√©ographie">G√©ographie</option>
                        <option value="EMC">EMC</option>
                        <option value="Fran√ßais">Fran√ßais</option>
                        <option value="Math√©matiques">Math√©matiques</option>
                        <option value="Physique">Physique</option>
                        <option value="Chimie">Chimie</option>
                        <option value="SVT">SVT</option>
                        <option value="Technologie">Technologie</option>
                        <option value="Anglais">Anglais</option>
                        <option value="Espagnol">Espagnol</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ID du chapitre</label>
                    <input type="text" id="chapterId" required placeholder="Ex: H1, G2, etc.">
                </div>
                <div class="form-group">
                    <label>Nom du chapitre</label>
                    <input type="text" id="chapterName" required placeholder="Nom du chapitre">
                </div>
                <div class="form-group">
                    <label>Lien Quiz 1</label>
                    <input type="url" id="quizLink1" placeholder="URL du quiz 1">
                </div>
                <div class="form-group">
                    <label>Lien Quiz 2 (Optionnel)</label>
                    <input type="url" id="quizLink2" placeholder="URL du quiz 2">
                </div>
                <div class="form-group">
                    <label>Lien Quiz 3 (Optionnel)</label>
                    <input type="url" id="quizLink3" placeholder="URL du quiz 3">
                </div>
                <div class="form-group">
                    <label>Lien Vid√©o 1</label>
                    <input type="url" id="videoLink1" placeholder="URL de la vid√©o 1">
                </div>
                <div class="form-group">
                    <label>Lien Vid√©o 2 (Optionnel)</label>
                    <input type="url" id="videoLink2" placeholder="URL de la vid√©o 2">
                </div>
                <div class="form-group">
                    <label>Lien Vid√©o 3 (Optionnel)</label>
                    <input type="url" id="videoLink3" placeholder="URL de la vid√©o 3">
                </div>
                <div class="popup-actions">
                    <button class="note-submit" onclick="submitNewChapter()">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button class="delete-btn" id="deleteChapterBtn" onclick="deleteChapter(document.getElementById('chapterId').value)" style="display: none;">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de confirmation -->
    <div class="confirm-popup" id="confirmPopup">
        <div class="confirm-popup-content">
            <div class="confirm-popup-header">
                <div class="confirm-popup-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmation
                </div>
            </div>
            <div class="confirm-popup-body">
                <p id="confirmMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
            </div>
            <div class="confirm-popup-actions">
                <button class="confirm-btn confirm-cancel" onclick="closeConfirmPopup()">Annuler</button>
                <button class="confirm-btn confirm-yes" id="confirmYesBtn">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://yfxbheoyavydissfpvwh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmeGJoZW95YXZ5ZGlzc2ZwdndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwOTI0NTEsImV4cCI6MjA2MzY2ODQ1MX0.n10JVF_CSap7fmdbQYcgpmtrfacOX9HBaSB779KrV1o';

        // Corriger la configuration des mati√®res
        const SUBJECTS_CONFIG = {
            'Histoire': { emoji: 'üèõÔ∏è', color: 'var(--primary-color)', type: 'histoire', display: 'Histoire' },
            'G√©ographie': { emoji: 'üó∫Ô∏è', color: 'var(--primary-color)', type: 'geographie', display: 'G√©ographie' },
            'EMC': { emoji: '‚öñÔ∏è', color: 'var(--primary-color)', type: 'emc', display: 'EMC' },
            'Fran√ßais': { emoji: 'üìö', color: 'var(--primary-color)', type: 'francais', display: 'Fran√ßais' },
            'Math√©matiques': { emoji: 'üìê', color: 'var(--primary-color)', type: 'mathematiques', display: 'Math√©matiques' },
            'Physique': { emoji: '‚ö°', color: 'var(--primary-color)', type: 'physique', display: 'Physique' },
            'Chimie': { emoji: 'üß™', color: 'var(--primary-color)', type: 'chimie', display: 'Chimie' },
            'SVT': { emoji: 'üß¨', color: 'var(--primary-color)', type: 'svt', display: 'SVT' },
            'Technologie': { emoji: 'üîß', color: 'var(--primary-color)', type: 'techno', display: 'Technologie' },
            'Anglais': { emoji: 'üá¨üáß', color: 'var(--primary-color)', type: 'anglais', display: 'Anglais' },
            'Espagnol': { emoji: 'üá™üá∏', color: 'var(--primary-color)', type: 'espagnol', display: 'Espagnol' }
        };

        // Map de correspondance pour g√©rer la casse
        const TYPE_MAP = {
            'histoire': 'Histoire',
            'geographie': 'Geographie',
            'emc': 'emc',
            'francais': 'Francais',
            'mathematiques': 'Mathematiques',
            'physique': 'Physique',
            'chimie': 'Chimie',
            'svt': 'SVT',
            'techno': 'Techno',
            'anglais': 'Anglais',
            'espagnol': 'Espagnol'
        };

        // 2. Remplacer la fonction createSubjectCard
        function createSubjectCard(subject) {
            const config = SUBJECTS_CONFIG[subject];
            if (!config) {
                console.error('Configuration manquante pour:', subject);
                return '';
            }
            
            return `
                <div class="subject-card ${config.type}">
                    <div class="subject-header" onclick="toggleSubject(this)">
                        <div class="subject-title">
                            <div class="subject-emoji">${config.emoji}</div>
                            <h3>${subject}</h3>
                        </div>
                        <div class="subject-controls">
                            <div class="subject-progress">
                                <span class="completed">0</span>/<span class="total">0</span>
                            </div>
                            <div class="subject-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="chapters-content" style="display: none;">
                        <div class="chapters-list"></div>
                    </div>
                </div>
            `;
        }

        // Modifier la fonction addChapter pour mieux g√©rer l'affichage
        function addChapter(subject, chapterName, description, links, ressources, chapterId) {
            // Trouver la bonne mati√®re dans SUBJECTS_CONFIG
            const subjectEntry = Object.entries(SUBJECTS_CONFIG).find(([_, config]) => config.type === subject);
            if (!subjectEntry) {
                console.error("Mati√®re non trouv√©e pour le type:", subject);
                return;
            }
            
            const [subjectKey] = subjectEntry;
            const subjectCard = document.querySelector(`.subject-card.${subject}`);
            if (subjectCard) {
                const chaptersList = subjectCard.querySelector('.chapters-list');
                if (chaptersList) {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'chapter-item';

                    // Construire les boutons de ressources dynamiquement
                    let resourceButtonsHTML = '';
                    // Tous les boutons Quiz appellent maintenant showResource
                    if (ressources.quiz && ressources.quiz[0]) {
                         resourceButtonsHTML += `
                            <button class="resource-btn quiz-btn" onclick="showResource('quiz', '${subject}', '${chapterName}', '${ressources.quiz[0]}', '${chapterId}')">
                                <i class="fas fa-question-circle"></i> Quiz 1
                            </button>
                        `;
                    }
                    if (ressources.quiz && ressources.quiz[1]) {
                         resourceButtonsHTML += `
                            <button class="resource-btn quiz-btn" onclick="showResource('quiz', '${subject}', '${chapterName}', '${ressources.quiz[1]}', '${chapterId}')">
                                <i class="fas fa-question-circle"></i> Quiz 2
                            </button>
                        `;
                    }
                    if (ressources.quiz && ressources.quiz[2]) {
                         resourceButtonsHTML += `
                            <button class="resource-btn quiz-btn" onclick="showResource('quiz', '${subject}', '${chapterName}', '${ressources.quiz[2]}', '${chapterId}')">
                                <i class="fas fa-question-circle"></i> Quiz 3
                            </button>
                        `;
                    }
                    // Boutons Vid√©o 1, 2, et 3 (ouvrent directement le lien)
                    if (ressources.videos && ressources.videos[0]) {
                        resourceButtonsHTML += `
                            <button class="resource-btn video-btn" onclick="window.open('${ressources.videos[0]}', '_blank')">
                                <i class="fab fa-youtube"></i> Vid√©o 1
                            </button>
                        `;
                    }
                     if (ressources.videos && ressources.videos[1]) {
                        resourceButtonsHTML += `
                            <button class="resource-btn video-btn" onclick="window.open('${ressources.videos[1]}', '_blank')">
                                <i class="fab fa-youtube"></i> Vid√©o 2
                            </button>
                        `;
                    }
                     if (ressources.videos && ressources.videos[2]) {
                        resourceButtonsHTML += `
                            <button class="resource-btn video-btn" onclick="window.open('${ressources.videos[2]}', '_blank')">
                                <i class="fab fa-youtube"></i> Vid√©o 3
                            </button>
                        `;
                    }

                    chapterItem.innerHTML = `
                        <div class="chapter-info">
                            <div class="chapter-header">
                                <div class="chapter-id">${chapterId}</div>
                                <div class="chapter-name">${chapterName}</div>
                                <button class="edit-btn" onclick="editChapter('${chapterId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="chapter-resources">
                                ${resourceButtonsHTML}
                            </div>
                        </div>
                        <div class="chapter-complete">
                            <input type="checkbox" id="complete-${chapterId}" onchange="updateProgress(this)">
                            <label for="complete-${chapterId}">Termin√©</label>
                        </div>
                    `;
                    chaptersList.appendChild(chapterItem);
                    updateStats();
                } else {
                    console.error("Liste des chapitres non trouv√©e pour:", subject);
                }
            } else {
                console.error("Carte de mati√®re non trouv√©e pour:", subject);
            }
        }

        // Fonction pour obtenir l'emoji correspondant √† une mati√®re
        function getEmojiForSubject(subject) {
            return SUBJECTS_CONFIG[subject]?.emoji || 'üìö';
        }

        // 3. Modifier la fonction loadChapters
        async function loadChapters() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/revisions?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                
                const chapters = await response.json();
                const chaptersBySubject = {};
                
                chapters.forEach(chapter => {
                    const matiere = chapter.matiere.toLowerCase();
                    // Trouver la mati√®re correspondante dans SUBJECTS_CONFIG
                    const subjectEntry = Object.entries(SUBJECTS_CONFIG).find(
                        ([_, config]) => config.type === matiere
                    );
                    
                    if (subjectEntry) {
                        const [subject] = subjectEntry;
                        if (!chaptersBySubject[subject]) {
                            chaptersBySubject[subject] = [];
                        }
                        chaptersBySubject[subject].push(chapter);
                    }
                });

                const subjectsContainer = document.querySelector('.subjects-container');
                subjectsContainer.innerHTML = '';

                // Cr√©er les cartes pour toutes les mati√®res
                Object.keys(SUBJECTS_CONFIG).forEach(subject => {
                    const newCard = createSubjectCard(subject);
                    subjectsContainer.insertAdjacentHTML('beforeend', newCard);
                });

                // Ajouter les chapitres
                Object.entries(chaptersBySubject).forEach(([subject, subjectChapters]) => {
                    subjectChapters.forEach(chapter => {
                        addChapter(
                            SUBJECTS_CONFIG[subject].type,
                            chapter.chapitre,
                            '',
                            [],
                            {
                                quiz: [chapter.lien_quiz_1, chapter.lien_quiz_2, chapter.lien_quiz_3].filter(Boolean),
                                videos: [chapter.lien_video_1, chapter.lien_video_2, chapter.lien_video_3].filter(Boolean)
                            },
                            chapter.id
                        );
                    });
                });

                updateStats();
            } catch (error) {
                console.error('Erreur lors du chargement des chapitres:', error);
                showCustomAlert('Erreur lors du chargement des chapitres: ' + error.message, 'error');
            }
        }

        // Fonction pour cr√©er un feu d'artifice
        function createFirework(x, y) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = x + 'px';
            firework.style.top = y + 'px';
            document.body.appendChild(firework);

            // Cr√©er les particules
            const particleCount = 24; // Beaucoup plus de particules
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                const angle = (i / particleCount) * Math.PI * 2;
                const velocity = 4 + Math.random() * 4; // Vitesse encore plus √©lev√©e
                particle.style.setProperty('--angle', angle + 'rad');
                particle.style.setProperty('--velocity', velocity);
                // Plus de couleurs
                const colors = [
                    'var(--success-color)', 
                    'var(--primary-color)', 
                    'var(--warning-color)', 
                    'var(--info-color)',
                    'var(--purple-color)',
                    'var(--pink-color)',
                    'var(--yellow-color)',
                    '#FF0000', // Rouge
                    '#00FF00', // Vert
                    '#0000FF', // Bleu
                    '#FF00FF', // Magenta
                    '#00FFFF'  // Cyan
                ];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.setProperty('--particle-color', randomColor);
                firework.appendChild(particle);
            }

            // Supprimer le feu d'artifice apr√®s l'animation
            setTimeout(() => {
                firework.remove();
            }, 2000); // Animation plus longue
        }

        // Fonction pour cr√©er plusieurs feux d'artifice
        function createFireworks(x, y) {
            const fireworkCount = 20; // Beaucoup plus de feux d'artifice
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    // Position al√©atoire sur l'√©cran
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    const randomX = Math.random() * screenWidth;
                    const randomY = Math.random() * screenHeight;
                    createFirework(randomX, randomY);
                }, i * 100); // D√©lai encore plus court entre chaque feu d'artifice
            }

            // Cr√©er une deuxi√®me vague de feux d'artifice
            setTimeout(() => {
                for (let i = 0; i < fireworkCount; i++) {
                    setTimeout(() => {
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const randomX = Math.random() * screenWidth;
                        const randomY = Math.random() * screenHeight;
                        createFirework(randomX, randomY);
                    }, i * 100);
                }
            }, 1000);
        }

        // Modifier la fonction updateProgress pour inclure l'animation
        function updateProgress(checkbox) {
            const chapterItem = checkbox.closest('.chapter-item');
            const subjectCard = chapterItem.closest('.subject-card');
            const progressInfo = subjectCard.querySelector('.subject-progress');
            const totalChapters = subjectCard.querySelectorAll('.chapter-item').length;
            const completedChapters = subjectCard.querySelectorAll('.chapter-item input[type="checkbox"]:checked').length;
            
            progressInfo.querySelector('.completed').textContent = completedChapters;
            progressInfo.querySelector('.total').textContent = totalChapters;

            // Ajouter l'animation de c√©l√©bration
            if (checkbox.checked) {
                const completeButton = chapterItem.querySelector('.chapter-complete');
                completeButton.classList.add('celebrating');
                
                // Cr√©er les feux d'artifice sur tout l'√©cran
                createFireworks();

                // Retirer la classe d'animation apr√®s un d√©lai
                setTimeout(() => {
                    completeButton.classList.remove('celebrating');
                }, 500);
            }
            
            updateStats();
        }

        // Fonction pour mettre √† jour les statistiques
        function updateStats() {
            const totalChapters = document.querySelectorAll('.chapter-item').length;
            const completedChapters = document.querySelectorAll('.chapter-item input[type="checkbox"]:checked').length;
            const remainingChapters = totalChapters - completedChapters;
            // D√©finir la variable progress avant de l'utiliser
            const progress = totalChapters > 0 ? (completedChapters / totalChapters) * 100 : 0;

            // Mise √† jour des statistiques
            document.getElementById('total-chapters').textContent = totalChapters;
            document.getElementById('completed-chapters').textContent = completedChapters;
            document.getElementById('remaining-chapters').textContent = remainingChapters;
            document.querySelector('.progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-percentage').textContent = `${Math.round(progress)}%`;

            // Mise √† jour des compteurs par mati√®re
            document.querySelectorAll('.subject-card').forEach(card => {
                const subjectChapters = card.querySelectorAll('.chapter-item').length;
                const subjectCompleted = card.querySelectorAll('.chapter-item input[type="checkbox"]:checked').length;
                const progressInfo = card.querySelector('.subject-progress');
                if (progressInfo) {
                    progressInfo.querySelector('.completed').textContent = subjectCompleted;
                    progressInfo.querySelector('.total').textContent = subjectChapters;
                }
            });
        }

        // Gestion de l'affichage des r√©visions
        const showNotesBtn = document.getElementById('show-notes-btn');
        const showRevisionsBtn = document.getElementById('show-revisions-btn');
        const revisionsSection = document.querySelector('.revisions-section');
        const notesSection = document.querySelector('.notes-section');
        let isRevisionsVisible = false;
        let isNotesVisible = false;

        showNotesBtn.addEventListener('click', async () => {
            isNotesVisible = !isNotesVisible;
            
            // Fermer la section R√©visions si elle est ouverte
            if (isRevisionsVisible) {
                isRevisionsVisible = false;
                revisionsSection.style.display = 'none';
                showRevisionsBtn.innerHTML = '<i class="fas fa-book"></i> R√©visions';
            }

            // G√©rer l'affichage de la section Notes
            notesSection.style.display = isNotesVisible ? 'block' : 'none';
            showNotesBtn.innerHTML = isNotesVisible ? 
                '<i class="fas fa-times"></i> Fermer' : 
                '<i class="fas fa-star"></i> Notes et Moyennes';
            
            if (isNotesVisible) {
                await loadNotes();
            }
        });

        showRevisionsBtn.addEventListener('click', () => {
            isRevisionsVisible = !isRevisionsVisible;
            
            // Fermer la section Notes si elle est ouverte
            if (isNotesVisible) {
                isNotesVisible = false;
                notesSection.style.display = 'none';
                showNotesBtn.innerHTML = '<i class="fas fa-star"></i> Notes et Moyennes';
            }

            // G√©rer l'affichage de la section R√©visions
            revisionsSection.style.display = isRevisionsVisible ? 'block' : 'none';
            showRevisionsBtn.innerHTML = isRevisionsVisible ? 
                '<i class="fas fa-times"></i> Fermer' : 
                '<i class="fas fa-book"></i> R√©visions';
        });

        // Remplacer la fonction loadNotes
        async function loadNotes() {
            try {
                // Charger les r√©sultats des quiz et les chapitres
                const [notesResponse, chaptersResponse] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/quiz_resultats?select=*`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }),
                    fetch(`${SUPABASE_URL}/rest/v1/revisions?select=*`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    })
                ]);

                const notes = await notesResponse.json();
                const chapters = await chaptersResponse.json();
                
                // Cr√©er un Map des chapitres pour un acc√®s rapide
                const chaptersMap = new Map(chapters.map(chapter => [chapter.id, chapter]));
                
                // Organiser les notes par mati√®re
                const notesBySubject = {};
                
                // Initialiser toutes les mati√®res
                Object.keys(SUBJECTS_CONFIG).forEach(subject => {
                    notesBySubject[SUBJECTS_CONFIG[subject].type] = [];
                });

                // Ajouter les notes existantes
                notes.forEach(note => {
                    const chapter = chaptersMap.get(note.chapitre_id);
                    if (chapter) {
                        // Corriger la d√©tection du num√©ro de quiz en utilisant une comparaison plus pr√©cise
                        let quizNumber;
                        if (note.quiz_url === chapter.lien_quiz_1) quizNumber = 1;
                        else if (note.quiz_url === chapter.lien_quiz_2) quizNumber = 2;
                        else if (note.quiz_url === chapter.lien_quiz_3) quizNumber = 3;
                        else quizNumber = 1; // Par d√©faut quiz 1 si on ne trouve pas de correspondance

                        if (!notesBySubject[note.matiere]) {
                            notesBySubject[note.matiere] = [];
                        }
                        notesBySubject[note.matiere].push({
                            ...note,
                            quizNumber,
                            chapitreName: chapter.chapitre
                        });
                    }
                });

                const container = document.querySelector('.subjects-container-notes');
                container.innerHTML = '';

                // Cr√©er une carte pour chaque mati√®re
                Object.keys(SUBJECTS_CONFIG).forEach(subject => {
                    const config = SUBJECTS_CONFIG[subject];
                    const subjectNotes = notesBySubject[config.type] || [];
                    
                    // Calculer la moyenne
                    const totalNotes = subjectNotes.reduce((acc, note) => {
                        return acc + (note.note * 20) / note.bareme;
                    }, 0);
                    const averageNote = subjectNotes.length > 0 ? 
                        (totalNotes / subjectNotes.length).toFixed(2) : 
                        'Pas de note';

                    const card = document.createElement('div');
                    card.className = `subject-card ${config.type}`;
                    card.innerHTML = `
                        <div class="subject-header" onclick="toggleSubject(this)">
                            <div class="subject-title">
                                <div class="subject-emoji">${config.emoji}</div>
                                <h3>${subject}</h3>
                            </div>
                            <div class="subject-controls">
                                <div class="subject-average">Moyenne: ${averageNote}${subjectNotes.length > 0 ? '/20' : ''}</div>
                                <div class="subject-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                        <div class="chapters-content" style="display: none;">
                            <div class="notes-list">
                                ${subjectNotes.length > 0 ? subjectNotes.map(note => `
                                    <div class="note-item">
                                        <div class="note-info">
                                            <div class="note-chapter">${note.chapitre_id} - ${note.chapitreName}</div>
                                            <div class="note-value">Quiz ${note.quizNumber}: ${note.note}/${note.bareme}</div>
                                        </div>
                                        <div class="note-date">${new Date(note.date).toLocaleDateString()}</div>
                                    </div>
                                `).join('') : '<div class="note-item empty">Aucune note pour cette mati√®re</div>'}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des notes:', error);
                showCustomAlert('Erreur lors du chargement des notes: ' + error.message, 'error');
            }
        }

        // Fonction pour basculer l'affichage d'une mati√®re
        function toggleSubject(header) {
            const card = header.closest('.subject-card');
            const content = card.querySelector('.chapters-content');
            const arrow = header.querySelector('.subject-arrow i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.remove('fa-chevron-down');
                arrow.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('fa-chevron-up');
                arrow.classList.add('fa-chevron-down');
            }
        }

        // Initialisation des mati√®res
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les chapitres depuis Supabase
            loadChapters();
        });

        // Variables globales pour stocker les informations du quiz
        let currentQuizInfo = {
            subject: '',
            chapter: '',  // nom du chapitre
            chapterId: '', // ID du chapitre
            url: ''
        };

        // Remplacer la fonction showResource
        function showResource(type, subject, chapterName, resourceUrl, chapterId) {
            if (type === 'quiz') {
                currentQuizInfo = {
                    subject: subject,
                    chapter: chapterName,
                    chapterId: chapterId,
                    url: resourceUrl
                };

                // Afficher le popup de note
                const popup = document.getElementById('notePopup');
                popup.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('active');
                    document.getElementById('noteInput').focus();
                }, 10);

                // Ouvrir le quiz dans un nouvel onglet
                if (resourceUrl) {
                    window.open(resourceUrl, '_blank');
                }
            } else if (resourceUrl) {
                window.open(resourceUrl, '_blank');
            }
        }

        // Remplacer la fonction closeNotePopup
        function closeNotePopup() {
            const popup = document.getElementById('notePopup');
            popup.classList.remove('active');
            setTimeout(() => {
                popup.style.display = 'none';
                document.getElementById('noteInput').value = '';
            }, 300);
        }

        // Fonction pour fermer le popup
        function closeNotePopup() {
            document.getElementById('notePopup').classList.remove('active');
            document.getElementById('noteInput').value = '';
        }

        // Fonction pour afficher une alerte personnalis√©e
        function showCustomAlert(message, type = 'info', duration = 2000) {
            const container = document.getElementById('custom-alert-container');
            const alertElement = document.createElement('div');
            alertElement.classList.add('custom-alert', type);
            
            // Ajouter l'ic√¥ne appropri√©e selon le type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            alertElement.innerHTML = `${icon}${message}`;
            container.appendChild(alertElement);

            // Forcer le reflow pour l'animation CSS
            void alertElement.offsetWidth;

            alertElement.classList.add('show');

            // Masquer l'alerte apr√®s la dur√©e sp√©cifi√©e
            setTimeout(() => {
                alertElement.classList.remove('show');
                // Retirer l'√©l√©ment du DOM apr√®s la fin de la transition
                alertElement.addEventListener('transitionend', () => alertElement.remove());
            }, duration);
        }

        // Fonction pour soumettre la note
        async function submitNote() {
            const note = document.getElementById('noteInput').value;
            const scale = document.getElementById('noteScale').value;
            const maxNote = parseInt(scale);
            
            if (note && note >= 0 && note <= maxNote) {
                try {
                    // Cr√©er un ID unique
                    const uniqueId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    const data = {
                        id: uniqueId,
                        chapitre_id: currentQuizInfo.chapterId, // Utiliser l'ID correct du chapitre
                        matiere: currentQuizInfo.subject,
                        note: parseFloat(note),
                        bareme: parseInt(scale),
                        date: new Date().toISOString(),
                        quiz_url: currentQuizInfo.url || null
                    };

                    console.log('Envoi des donn√©es:', data); // Pour debug

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/quiz_resultats`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erreur lors de l\'enregistrement');
                    }

                    closeNotePopup();
                    showCustomAlert('Note enregistr√©e avec succ√®s !', 'success');
                } catch (error) {
                    console.error('Erreur d√©taill√©e:', error);
                    showCustomAlert('Erreur lors de l\'enregistrement de la note: ' + error.message, 'error');
                }
            } else {
                showCustomAlert(`Veuillez entrer une note valide entre 0 et ${maxNote}`, 'warning');
            }
        }

        // Fermer le popup si on clique en dehors
        document.getElementById('notePopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeNotePopup();
            }
        });

        // G√©rer la touche Entr√©e
        document.getElementById('noteInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitNote();
            }
        });

        // Modifier les fonctions de gestion du popup
        function showAddChapterPopup(isEditing = false) {
            const popup = document.getElementById('addChapterPopup');
            const deleteBtn = document.getElementById('deleteChapterBtn');
            popup.style.display = 'flex';
            popup.classList.add('active');
            
            // Afficher/masquer le bouton supprimer selon le mode
            deleteBtn.style.display = isEditing ? 'block' : 'none';
            
            if (!isEditing) {
                resetAddChapterForm();
            }
        }

         function resetAddChapterForm() {
            const chapterIdInput = document.getElementById('chapterId');
            chapterIdInput.readOnly = false;
            chapterIdInput.value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('chapterName').value = '';
            document.getElementById('quizLink1').value = '';
            document.getElementById('quizLink2').value = '';
            document.getElementById('quizLink3').value = '';
            document.getElementById('videoLink1').value = '';
            document.getElementById('videoLink2').value = '';
            document.getElementById('videoLink3').value = '';
         }

        function closeAddChapterPopup() {
            const popup = document.getElementById('addChapterPopup');
            popup.style.display = 'none';
            popup.classList.remove('active');
            resetAddChapterForm();
        }

        // Ajouter l'√©couteur d'√©v√©nement pour le bouton d'ajout
        document.addEventListener('DOMContentLoaded', function() {
            const addChapterBtn = document.getElementById('add-chapter-btn');
            if (addChapterBtn) {
                addChapterBtn.addEventListener('click', () => showAddChapterPopup());
            }

            // Fermer le popup si on clique en dehors
            const addChapterPopup = document.getElementById('addChapterPopup');
            if (addChapterPopup) {
                addChapterPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAddChapterPopup();
                    }
                });
            }
        });

        async function submitNewChapter(event) {
            if (event) event.preventDefault();
            
            const selectedSubject = document.getElementById('subjectSelect').value;
            const config = SUBJECTS_CONFIG[selectedSubject];
            const chapterId = document.getElementById('chapterId').value;
            const chapterName = document.getElementById('chapterName').value;
            const isEditing = document.getElementById('chapterId').readOnly;

            if (!config || !chapterId || !chapterName) {
                showCustomAlert('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }

            try {
                const data = {
                    id: chapterId,
                    chapitre: chapterName,
                    matiere: config.type,
                    lien_quiz_1: document.getElementById('quizLink1').value || null,
                    lien_quiz_2: document.getElementById('quizLink2').value || null,
                    lien_quiz_3: document.getElementById('quizLink3').value || null,
                    lien_video_1: document.getElementById('videoLink1').value || null,
                    lien_video_2: document.getElementById('videoLink2').value || null,
                    lien_video_3: document.getElementById('videoLink3').value || null
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/revisions${isEditing ? `?id=eq.${chapterId}` : ''}`, {
                    method: isEditing ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(isEditing ? 'Erreur lors de la modification du chapitre' : 'Erreur lors de la cr√©ation du chapitre');
                }

                showCustomAlert(isEditing ? 'Chapitre modifi√© avec succ√®s!' : 'Chapitre ajout√© avec succ√®s!', 'success');
                closeAddChapterPopup();
                await loadChapters();
            } catch (error) {
                console.error('Erreur:', error);
                showCustomAlert(error.message, 'error');
            }
        }

        // Modifier la fonction editChapter
        async function editChapter(chapterId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/revisions?id=eq.${chapterId}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors du chargement du chapitre');
                }

                const chapters = await response.json();
                if (chapters.length > 0) {
                    const chapter = chapters[0];
                    // Rechercher la mati√®re correspondante
                    const subjectEntry = Object.entries(SUBJECTS_CONFIG).find(
                        ([_, config]) => config.type.toLowerCase() === chapter.matiere.toLowerCase()
                    );
                    
                    if (subjectEntry) {
                        const [subjectKey] = subjectEntry;
                        document.getElementById('subjectSelect').value = subjectKey;
                        const chapterIdInput = document.getElementById('chapterId');
                        chapterIdInput.value = chapter.id;
                        chapterIdInput.readOnly = true;
                        document.getElementById('chapterName').value = chapter.chapitre;
                        document.getElementById('quizLink1').value = chapter.lien_quiz_1 || '';
                        document.getElementById('quizLink2').value = chapter.lien_quiz_2 || '';
                        document.getElementById('quizLink3').value = chapter.lien_quiz_3 || '';
                        document.getElementById('videoLink1').value = chapter.lien_video_1 || '';
                        document.getElementById('videoLink2').value = chapter.lien_video_2 || '';
                        document.getElementById('videoLink3').value = chapter.lien_video_3 || '';
                        showAddChapterPopup(true);
                    } else {
                        console.error('Mati√®re non trouv√©e:', chapter.matiere);
                        showCustomAlert('Erreur: Mati√®re non trouv√©e', 'error');
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showCustomAlert(error.message, 'error');
            }
        }

        // Fonction pour supprimer un chapitre
        async function deleteChapter(chapterId) {
            showConfirmPopup('√ätes-vous s√ªr de vouloir supprimer ce chapitre ?', async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/revisions?id=eq.${chapterId}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Erreur lors de la suppression du chapitre');
                    }

                    showCustomAlert('Chapitre supprim√© avec succ√®s!', 'success');
                    closeAddChapterPopup();
                    await loadChapters();
                } catch (error) {
                    console.error('Erreur:', error);
                    showCustomAlert(error.message, 'error');
                }
            });
        }

        // Fonction pour afficher la notification temporaire
        function showNotification(message) {
            const notificationPopup = document.getElementById('notification-popup');
            notificationPopup.textContent = message;
            notificationPopup.classList.add('show');

            setTimeout(() => {
                notificationPopup.classList.remove('show');
            }, 2000); // 2000 millisecondes = 2 secondes
        }

        // Ajouter ces nouvelles fonctions
        function showConfirmPopup(message, callback) {
            const popup = document.getElementById('confirmPopup');
            const messageEl = document.getElementById('confirmMessage');
            const confirmBtn = document.getElementById('confirmYesBtn');
            
            messageEl.textContent = message;
            popup.style.display = 'flex';
            
            // Animation d'entr√©e
            setTimeout(() => popup.classList.add('active'), 10);
            
            // Configurer le bouton de confirmation
            confirmBtn.onclick = () => {
                closeConfirmPopup();
                callback();
            };
        }

        function closeConfirmPopup() {
            const popup = document.getElementById('confirmPopup');
            popup.classList.remove('active');
            setTimeout(() => popup.style.display = 'none', 300);
        }
    </script>

    <style>
        /* Styles pour les feux d'artifice */
        .firework {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
        }

        .firework-particle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--particle-color, var(--success-color)) 0%, transparent 70%);
            animation: particle 2s ease-out forwards;
            box-shadow: 0 0 15px var(--particle-color, var(--success-color));
        }

        @keyframes particle {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: 
                    translate(
                        calc(cos(var(--angle)) * var(--velocity) * 200px),
                        calc(sin(var(--angle)) * var(--velocity) * 200px)
                    )
                    scale(0);
                opacity: 0;
            }
        }

        .firework::before,
        .firework::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: fireworks 1.5s ease-out forwards;
        }

        .firework::before {
            background: radial-gradient(circle, var(--success-color) 0%, transparent 70%);
            box-shadow: 0 0 30px var(--success-color);
        }

        .firework::after {
            background: radial-gradient(circle, var(--primary-color) 0%, transparent 70%);
            animation-delay: 0.1s;
            box-shadow: 0 0 30px var(--primary-color);
        }

        @keyframes fireworks {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }

        /* Styles am√©lior√©s pour tous les popups */
        .note-popup,
        .confirm-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .note-popup.active,
        .confirm-popup.active {
            opacity: 1;
        }

        .note-popup-content,
        .confirm-popup-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .note-popup.active .note-popup-content,
        .confirm-popup.active .confirm-popup-content {
            transform: scale(1) translateY(0);
        }

        .note-popup-header,
        .confirm-popup-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .note-popup-title,
        .confirm-popup-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .note-popup-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .note-popup-close:hover {
            background: #f0f0f0;
            color: #333;
            transform: rotate(90deg);
        }

        .note-input-container {
            padding: 16px 0;
        }

        .note-input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .note-input-wrapper,
        .note-scale-wrapper {
            position: relative;
        }

        .note-input-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .note-input,
        .note-scale {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .note-input:focus,
        .note-scale:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
        }

        .confirm-popup-body {
            padding: 16px 0;
            color: #555;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .popup-actions,
        .confirm-popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 2px solid #f0f0f0;
        }

        .note-submit,
        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-submit,
        .confirm-yes {
            background: var(--primary-color);
            color: white;
        }

        .note-submit:hover,
        .confirm-yes:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .confirm-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .confirm-cancel:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* Responsive design */
        @media (max-width: 480px) {
            .note-input-group {
                flex-direction: column;
                gap: 16px;
            }

            .popup-actions,
            .confirm-popup-actions {
                flex-direction: column-reverse;
            }

            .note-submit,
            .confirm-btn {
                width: 100%;
                justify-content: center;
            }
        }

        .note-popup {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .note-popup.active {
            opacity: 1;
        }

        .notes-section {
            margin-top: 20px;
        }

        .note-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .note-chapter {
            font-weight: 500;
            color: #333;
        }

        .note-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .note-date {
            color: #666;
            font-size: 0.9em;
        }

        .subject-average {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 15px;
        }

        .not-mark {
            color: #ff4444;
            font-weight: bold;
            font-style: italic;
        }
    </style>
</body>
</html>
